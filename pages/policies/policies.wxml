<view class="container">
    <!-- 页面头部 -->
    <view class="header">
        <!-- 返回按钮 -->
        <view class="header-top">
            <view class="back-btn" bindtap="goBack" hover-class="back-btn-hover">
                <van-icon name="arrow-left" size="36rpx" color="#FFFFFF"/>
                <text class="back-text">返回</text>
            </view>
        </view>

        <view class="header-bg">
            <view class="header-decoration">
                <view class="decoration-circle circle-1"></view>
                <view class="decoration-circle circle-2"></view>
                <view class="decoration-circle circle-3"></view>
            </view>
        </view>
        <view class="header-content">
            <text class="title">政策法规</text>
            <text class="subtitle">查看相关政策文件</text>
        </view>
    </view>

    <!-- 政策分类列表 -->
    <view class="policy-categories">
        <!-- 养老照护床位政策 -->
        <view class="category-section">
            <view class="category-header" bindtap="toggleCategory" data-category="care">
                <view class="category-icon">
                    <van-icon name="hotel-o" size="40rpx" color="#ffffffff"/>
                </view>
                <view class="category-info">
                    <text class="category-title">养老照护床位政策</text>
                    <text class="category-desc">家庭照护床位相关政策文件</text>
                </view>
                <view class="expand-icon" wx:if="{{!expandedCategories.care}}">
                    <van-icon name="arrow" size="28rpx" color="#FF6B35"/>
                </view>
                <view class="expand-icon" wx:else>
                    <van-icon name="arrow-down" size="28rpx" color="#FF6B35"/>
                </view>
            </view>

            <view class="category-content" wx:if="{{expandedCategories.care}}">
                <view class="policy-item" wx:for="{{carePolicies}}" wx:key="id" bindtap="viewPdfImages" data-file="{{item.file}}" data-title="{{item.title}}" data-pages="{{item.totalPages}}" data-related-links="{{item.relatedLinks}}">
                    <view class="item-icon">
                        <van-icon name="description" size="24rpx" color="#FF8C42"/>
                    </view>
                    <view class="item-content">
                        <text class="item-title">{{item.title}}</text>
                        <text class="item-desc">{{item.desc}} ({{item.totalPages}}页)</text>
                    </view>
                    <view class="item-arrow">
                        <van-icon name="arrow" size="20rpx" color="#999"/>
                    </view>
                </view>
            </view>
        </view>

        <!-- 老年人能力评估政策 -->
        <view class="category-section">
            <view class="category-header" bindtap="toggleCategory" data-category="assessment">
                <view class="category-icon">
                    <van-icon name="orders-o" size="40rpx" color="#ffffffff"/>
                </view>
                <view class="category-info">
                    <text class="category-title">老年人能力评估政策</text>
                    <text class="category-desc">老年人能力评估相关政策文件</text>
                </view>
                <view class="expand-icon" wx:if="{{!expandedCategories.assessment}}">
                    <van-icon name="arrow" size="28rpx" color="#FF6B35"/>
                </view>
                <view class="expand-icon" wx:else>
                    <van-icon name="arrow-down" size="28rpx" color="#FF6B35"/>
                </view>
            </view>

            <view class="category-content" wx:if="{{expandedCategories.assessment}}">
                <view class="policy-item" wx:for="{{assessmentPolicies}}" wx:key="id" bindtap="viewPdfImages" data-file="{{item.file}}" data-title="{{item.title}}" data-pages="{{item.totalPages}}" data-related-links="{{item.relatedLinks}}">
                    <view class="item-icon">
                        <van-icon name="description" size="24rpx" color="#FF8C42"/>
                    </view>
                    <view class="item-content">
                        <text class="item-title">{{item.title}}</text>
                        <text class="item-desc">{{item.desc}} ({{item.totalPages}}页)</text>
                    </view>
                    <view class="item-arrow">
                        <van-icon name="arrow" size="20rpx" color="#999"/>
                    </view>
                </view>
            </view>
        </view>

        <!-- 老年人福利政策 -->
        <view class="category-section">
            <view class="category-header" bindtap="toggleCategory" data-category="welfare">
                <view class="category-icon">
                    <van-icon name="gift-o" size="40rpx" color="#ffffffff"/>
                </view>
                <view class="category-info">
                    <text class="category-title">老年人福利政策</text>
                    <text class="category-desc">老年人福利补贴和服务相关政策文件</text>
                </view>
                <view class="expand-icon" wx:if="{{!expandedCategories.welfare}}">
                    <van-icon name="arrow" size="28rpx" color="#FF6B35"/>
                </view>
                <view class="expand-icon" wx:else>
                    <van-icon name="arrow-down" size="28rpx" color="#FF6B35"/>
                </view>
            </view>

            <view class="category-content" wx:if="{{expandedCategories.welfare}}">
                <!-- 政策文件列表 -->
                <view class="policy-item" wx:for="{{welfarePolicies}}" wx:key="id" bindtap="viewPdfImages" data-file="{{item.file}}" data-title="{{item.title}}" data-pages="{{item.totalPages}}">
                    <view class="item-icon">
                        <van-icon name="description" size="24rpx" color="#FF8C42"/>
                    </view>
                    <view class="item-content">
                        <text class="item-title">{{item.title}}</text>
                        <text class="item-desc">{{item.desc}} ({{item.totalPages}}页)</text>
                    </view>
                    <view class="item-arrow">
                        <van-icon name="arrow" size="20rpx" color="#999"/>
                    </view>
                </view>

                <!-- 快速链接分隔线 -->
                <view class="quick-link-divider"></view>

                <!-- 办事指南快速链接 -->
                <view class="quick-link-item" bindtap="openExternalLink" data-url="{{servicesGuide.url}}">
                    <view class="quick-link-icon">
                        <van-icon name="link-o" size="24rpx" color="#FF6B35"/>
                    </view>
                    <view class="quick-link-content">
                        <text class="quick-link-title">{{servicesGuide.title}}</text>
                        <text class="quick-link-desc">{{servicesGuide.desc}}</text>
                    </view>
                    <view class="quick-link-arrow">
                        <van-icon name="share" size="20rpx" color="#FF8C42"/>
                    </view>
                </view>

                <!-- 补贴专栏 -->
                <view class="subsidy-section">
                    <view class="subsidy-header" bindtap="toggleCategory" data-category="subsidyList">
                        <view class="subsidy-icon">
                            <van-icon name="bag-o" size="28rpx" color="#FF6B35"/>
                        </view>
                        <view class="subsidy-info">
                            <text class="subsidy-title">补贴专栏</text>
                            <text class="subsidy-desc">点击展开查看补贴详情</text>
                        </view>
                        <view class="subsidy-expand-icon" wx:if="{{!expandedCategories.subsidyList}}">
                            <van-icon name="arrow" size="24rpx" color="#FF8C42"/>
                        </view>
                        <view class="subsidy-expand-icon" wx:else>
                            <van-icon name="arrow-up" size="24rpx" color="#FF8C42"/>
                        </view>
                    </view>

                    <!-- 补贴项目列表 -->
                    <view class="subsidy-list" wx:if="{{expandedCategories.subsidyList}}">
                        <view class="subsidy-item" wx:for="{{subsidyItems}}" wx:key="id" bindtap="openExternalLink" data-url="{{item.url}}">
                            <view class="subsidy-item-icon">
                                <van-icon name="link-o" size="26rpx" color="#FF6B35"/>
                            </view>
                            <view class="subsidy-item-content">
                                <text class="subsidy-item-title">{{item.title}}</text>
                                <text class="subsidy-item-desc">{{item.desc}}</text>
                            </view>
                            <view class="subsidy-item-arrow">
                                <van-icon name="arrow" size="18rpx" color="#FF8C42"/>
                            </view>
                        </view>
                    </view>
                </view>
            </view>
        </view>
    </view>

    <!-- 分类提示 -->
    <view class="category-tip" wx:if="{{!showImageViewer}}">
        <van-icon name="info-o" size="28rpx" color="#FF8C42"/>
        <text class="tip-text">点击分类可展开查看相关政策文件</text>
    </view>

    <!-- PDF预览区域 -->
    <view class="image-viewer-overlay" wx:if="{{showImageViewer}}">
        <view class="image-viewer">
            <view class="viewer-header">
                <view class="back-btn" bindtap="closeImageViewer" hover-class="back-btn-hover">
                    <van-icon name="arrow-left" size="36rpx" color="#FFFFFF"/>
                    <text class="back-text">返回</text>
                </view>
                <view class="viewer-title-section">
                    <text class="viewer-title">{{currentPdfTitle}}</text>
                    <text class="viewer-page-info">{{loadedPages}}/{{currentPdfTotalPages}}页</text>
                </view>
            </view>

            <!-- 相关链接栏（可随页面滑动） -->
            <block wx:if="{{showRelatedLinks && displayedRelatedLinks.length}}">
                <view class="related-link-tip" wx:if="{{canToggleRelatedLinks}}">
                    <van-icon name="info-o" size="26rpx" color="#FF6B35" />
                    <text class="related-link-tip-text">可{{relatedLinksExpanded ? '收起' : '展开'}}查看更多外部链接，便于在浏览器打开原文。</text>
                </view>
                <view class="related-link-bar" wx:for="{{displayedRelatedLinks}}" wx:key="index">
                    <view class="related-link-content" bindtap="openExternalLink" data-url="{{item.url}}">
                        <view class="related-link-icon">
                            <van-icon name="link-o" size="24rpx" color="#FF6B35"/>
                        </view>
                        <view class="related-link-text">
                            <text class="related-link-title">{{item.title}}</text>
                            <text class="related-link-arrow">点击查看原文 →</text>
                        </view>
                    </view>
                </view>
                <view class="related-link-toggle" wx:if="{{canToggleRelatedLinks}}" bindtap="toggleRelatedLinks">
                    <van-icon class="related-link-toggle-icon" name="{{relatedLinksExpanded ? 'arrow-up' : 'arrow-down'}}" size="28rpx" color="#FF6B35" />
                    <text>{{relatedLinksExpanded ? '收起更多链接' : '展开更多链接'}}</text>
                </view>
            </block>

            <!-- 触摸层：处理缩放和拖拽 -->
            <view class="pdf-touch-layer"
                  bind:touchstart="onTouchStart"
                  bind:touchmove="onTouchMove"
                  bind:touchend="onTouchEnd"
                  bind:touchcancel="onTouchCancel">
                
                <scroll-view
                    class="pdf-viewer-scroll"
                    scroll-y="{{true}}"
                    enhanced="{{true}}"
                    fast-deceleration="{{true}}"
                    show-scrollbar="{{false}}"
                    scroll-with-animation="{{true}}"
                    bindscrolltolower="handleScrollToLower"
                    style="height: 100%;">>>>
                    
                    <!-- 整体缩放容器 -->
                    <view class="pdf-scale-container"
                          style="transform: scale({{scale}}) translate({{translateX}}px, {{translateY}}px); transform-origin: center top;">
                        
                        <view class="pdf-container">
                            <block wx:for="{{currentImageList}}" wx:key="page">
                                <view class="pdf-page-wrapper" data-page="{{item.page}}">
                                    <!-- 页码显示 -->
                                    <view class="page-indicator">
                                        <text>第{{item.page}}页 / 共{{currentPdfTotalPages}}页</text>
                                    </view>
                                    
                                    <!-- 图片容器 -->
                                    <view class="pdf-image-container">
                                        <image class="pdf-image" 
                                               src="{{item.url}}"
                                               data-url="{{item.url}}"
                                               data-index="{{index}}"
                                               mode="widthFix"
                                               bindload="handleImageLoad"
                                               binderror="handleImageError" />
                                    </view>
                                </view>
                            </block>
                            
                            <!-- 加载更多 -->
                            <view class="loading-indicator" wx:if="{{loadedPages < currentPdfTotalPages}}">
                                <van-loading color="#FF6B35" size="24px">加载更多页面...</van-loading>
                            </view>
                            
                            <!-- 文档结束 -->
                            <view class="document-end" wx:if="{{loadedPages >= currentPdfTotalPages}}">
                                <text>— 文档结束 —</text>
                            </view>
                        </view>
                    </view>
                </scroll-view>
            </view>
            
            <view class="image-controls">
                <view class="scale-tips">
                    <van-icon name="photo" size="24rpx" color="#FF6B35"/>
                    <text class="tip-label">双指缩放，单指拖拽</text>
                    <text class="scale-info">{{Math.round(scale * 100)}}%</text>
                </view>
            </view>
        </view>
    </view>
</view>
