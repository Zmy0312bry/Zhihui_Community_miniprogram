<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PDF预览</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            width: 100%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            background: white;
        }

        .header {
            background: linear-gradient(135deg, #FF6B35, #FF8C42);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 2px 10px rgba(255, 107, 53, 0.3);
            position: relative;
            z-index: 1000;
        }

        .title {
            font-size: 18px;
            font-weight: bold;
            flex: 1;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .close-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 20px;
            color: white;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .pdf-container {
            flex: 1;
            position: relative;
            overflow: auto;
            background: #f8f8f8;
        }

        .pdf-viewer {
            width: 100%;
            min-height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        .pdf-page {
            margin-bottom: 20px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
            background: white;
            max-width: 100%;
            overflow: hidden;
        }

        .pdf-canvas {
            display: block;
            max-width: 100%;
            height: auto;
        }

        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #FF6B35;
            font-size: 16px;
        }

        .error {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #ff4444;
            text-align: center;
            padding: 20px;
        }

        .error-icon {
            font-size: 48px;
            margin-bottom: 15px;
        }

        .controls {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 1000;
        }

        .control-btn {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, #FF6B35, #FF8C42);
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 15px rgba(255, 107, 53, 0.3);
            transition: all 0.3s ease;
        }

        .control-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 107, 53, 0.4);
        }

        .zoom-info {
            position: fixed;
            top: 80px;
            right: 20px;
            background: rgba(255, 107, 53, 0.9);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 1000;
            display: none;
        }

        @media (max-width: 768px) {
            .header {
                padding: 12px 15px;
            }

            .title {
                font-size: 16px;
            }

            .close-btn {
                width: 36px;
                height: 36px;
                font-size: 18px;
            }

            .pdf-viewer {
                padding: 15px;
            }

            .controls {
                bottom: 15px;
                right: 15px;
            }

            .control-btn {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="title" id="pdfTitle">PDF预览</div>
            <button class="close-btn" onclick="closeViewer()">×</button>
        </div>

        <div class="pdf-container">
            <div class="pdf-viewer" id="pdfViewer">
                <div class="loading" id="loading">
                    <div>正在加载PDF...</div>
                </div>
            </div>
        </div>

        <div class="controls">
            <button class="control-btn" onclick="zoomIn()" title="放大">+</button>
            <button class="control-btn" onclick="zoomOut()" title="缩小">−</button>
            <button class="control-btn" onclick="resetZoom()" title="重置">⟲</button>
        </div>

        <div class="zoom-info" id="zoomInfo"></div>
    </div>

    <!-- PDF.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js"></script>

    <script>
        // PDF.js 配置 - 完全移除worker依赖，专为小程序webview优化
        let pdfDoc = null;
        let currentScale = 1.5;
        let pdfUrl = '';
        let pdfTitle = '';

        // 获取URL参数
        function getUrlParams() {
            const urlParams = new URLSearchParams(window.location.search);
            pdfUrl = decodeURIComponent(urlParams.get('url') || '');
            pdfTitle = decodeURIComponent(urlParams.get('title') || 'PDF预览');

            console.log('PDF URL:', pdfUrl);
            console.log('PDF Title:', pdfTitle);

            document.getElementById('pdfTitle').textContent = pdfTitle;
        }

        // 加载PDF
        async function loadPDF() {
            console.log('开始加载PDF，URL:', pdfUrl);

            if (!pdfUrl) {
                console.error('PDF URL为空');
                showError('PDF链接无效');
                return;
            }

            // 检查URL是否可访问
            try {
                const response = await fetch(pdfUrl, { method: 'HEAD' });
                if (!response.ok) {
                    console.error('PDF文件不存在，状态码:', response.status);
                    showError('PDF文件不存在或无法访问');
                    return;
                }
                console.log('PDF文件可访问');
            } catch (error) {
                console.error('检查PDF文件时出错:', error);
                showError('无法访问PDF文件，请检查网络连接');
                return;
            }

            try {
                const loadingDiv = document.getElementById('loading');
                loadingDiv.style.display = 'flex';

                console.log('开始加载PDF文档...');

                // 完全移除worker依赖的PDF.js配置
                const loadingTask = pdfjsLib.getDocument({
                    url: pdfUrl,
                    // 禁用所有可能导致问题的功能
                    disableWorker: true,
                    disableRange: true,
                    disableStream: true,
                    disableAutoFetch: true,
                    // 简化配置以提高兼容性
                    verbosity: 0,
                    // 设置超时时间
                    docBaseUrl: '',
                    // 禁用字体缓存
                    disableFontFace: true,
                    // 禁用WebGL
                    disableWebGL: true
                });

                pdfDoc = await loadingTask.promise;
                console.log('PDF文档加载成功，页数:', pdfDoc.numPages);

                // 渲染所有页面
                await renderAllPages();

                loadingDiv.style.display = 'none';
                console.log('PDF渲染完成');
            } catch (error) {
                console.error('PDF加载失败:', error);
                // 提供更详细的错误信息
                let errorMessage = 'PDF加载失败';
                if (error.message.includes('Worker')) {
                    errorMessage += ': Worker配置问题，已自动禁用';
                } else if (error.message.includes('network')) {
                    errorMessage += ': 网络连接问题';
                } else if (error.message.includes('InvalidPDFException')) {
                    errorMessage += ': PDF文件格式错误';
                } else if (error.message.includes('MissingPDFException')) {
                    errorMessage += ': PDF文件不存在';
                } else {
                    errorMessage += `: ${error.message}`;
                }
                showError(errorMessage);
            }
        }

        // 渲染所有页面
        async function renderAllPages() {
            const pdfViewer = document.getElementById('pdfViewer');

            // 清空之前的页面
            const existingPages = pdfViewer.querySelectorAll('.pdf-page');
            existingPages.forEach(page => page.remove());

            for (let pageNum = 1; pageNum <= pdfDoc.numPages; pageNum++) {
                await renderPage(pageNum);
            }
        }

        // 渲染单页
        async function renderPage(pageNum) {
            try {
                const page = await pdfDoc.getPage(pageNum);
                const viewport = page.getViewport({ scale: currentScale });

                // 创建canvas元素
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                canvas.className = 'pdf-canvas';

                // 创建页面容器
                const pageDiv = document.createElement('div');
                pageDiv.className = 'pdf-page';
                pageDiv.appendChild(canvas);

                // 添加到页面
                const pdfViewer = document.getElementById('pdfViewer');
                const loadingDiv = document.getElementById('loading');
                pdfViewer.insertBefore(pageDiv, loadingDiv);

                // 渲染页面
                const renderContext = {
                    canvasContext: context,
                    viewport: viewport
                };

                await page.render(renderContext).promise;
            } catch (error) {
                console.error(`页面 ${pageNum} 渲染失败:`, error);
            }
        }

        // 显示错误信息
        function showError(message) {
            const pdfViewer = document.getElementById('pdfViewer');
            const loadingDiv = document.getElementById('loading');

            // 隐藏加载动画
            if (loadingDiv) {
                loadingDiv.style.display = 'none';
            }

            pdfViewer.innerHTML = `
                <div class="error">
                    <div class="error-icon">⚠️</div>
                    <div style="margin-bottom: 15px; font-weight: bold;">加载失败</div>
                    <div style="margin-bottom: 15px;">${message}</div>
                    <div style="font-size: 14px; color: #666;">
                        请检查网络连接或联系管理员
                    </div>
                </div>
            `;

            console.error('PDF查看器错误:', message);
        }

        // 放大
        function zoomIn() {
            currentScale = Math.min(currentScale + 0.25, 3.0);
            showZoomInfo();
            if (pdfDoc) {
                renderAllPages();
            }
        }

        // 缩小
        function zoomOut() {
            currentScale = Math.max(currentScale - 0.25, 0.5);
            showZoomInfo();
            if (pdfDoc) {
                renderAllPages();
            }
        }

        // 重置缩放
        function resetZoom() {
            currentScale = 1.5;
            showZoomInfo();
            if (pdfDoc) {
                renderAllPages();
            }
        }

        // 显示缩放信息
        function showZoomInfo() {
            const zoomInfo = document.getElementById('zoomInfo');
            zoomInfo.textContent = `缩放: ${Math.round(currentScale * 100)}%`;
            zoomInfo.style.display = 'block';

            setTimeout(() => {
                zoomInfo.style.display = 'none';
            }, 2000);
        }

        // 关闭预览
        function closeViewer() {
            // 通过postMessage通知小程序关闭
            if (window.parent && window.parent.postMessage) {
                window.parent.postMessage({
                    type: 'closePdfViewer'
                }, '*');
            }

            // 如果在小程序中，通过微信API关闭
            if (typeof wx !== 'undefined' && wx.miniProgram) {
                wx.miniProgram.navigateBack();
            }
        }

        // 监听消息
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'closePdfViewer') {
                // 处理关闭消息
                console.log('收到关闭消息');
            }
        }, { passive: true });

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            getUrlParams();
            loadPDF();
        }, { passive: true });

        // 处理页面可见性变化
        document.addEventListener('visibilitychange', function() {
            if (document.hidden) {
                // 页面隐藏时的处理
            } else {
                // 页面显示时的处理
            }
        }, { passive: true });
    </script>
</body>
</html>
