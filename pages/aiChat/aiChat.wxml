<view doc navBg="bg-gradient-green" title="{{typePage}}" ui="text-white">
    <!-- ÁÇπÂáªÂ§ñÈÉ®Âå∫ÂüüÁöÑÈÅÆÁΩ©Â±Ç -->
    <view wx:if="{{isInputExpanded}}" class="input-mask" bindtap="onClickOutside"></view>

    <!-- Ëá™ÂÆö‰πâÂä†ËΩΩÂä®Áîª -->
    <view wx:if="{{ttsLoading}}" class="tts-loading-overlay">
        <view class="tts-loading-container">
            <view class="tts-loading-spinner">
                <view class="tts-loading-dot" wx:for="{{[1,2,3]}}" wx:key="*this"></view>
            </view>
            <view class="tts-loading-text">{{ttsLoadingText}}</view>
            <view class="tts-loading-progress">
                <view class="tts-progress-bar" style="width: {{ttsProgress}}%"></view>
            </view>
        </view>
    </view>

    <!--ÂÜÖÂÆπÂå∫Âüü-->
    <view class="bottom-height content-view">
        <scroll-view
            class="scroll-text"
            type="list"
            scroll-y
            enable-passive
            scroll-top="{{scrollTop}}"
            upper-threshold="50"
            enhanced="true"
            bounces="true"
            show-scrollbar="false"
        >
            <view>
                <!-- Ê¨¢ËøéÈ°µÈù¢ -->
                <view wx:if="{{chatList.length<=0}}" class="begin">
                    <view class="welcome-header">
                        <image src="{{mediaUrls.icowwn}}" class="welcome-avatar" mode="aspectFit"/>
                    </view>
                    <view class="begin-title">{{beginTitle}}</view>
                    <view class="begin-tips">{{beginTips}}</view>
                    <view class="tts-feature-hint">
                        <van-icon name="volume-o" size="16" color="#FF9800"/>
                        <text>üí° ÁÇπÂáªAIÂõûÂ§çÂÜÖÂÆπÂç≥ÂèØÊí≠ÊîæËØ≠Èü≥</text>
                    </view>
                    <view class="suggestion-list">
                        <view wx:for="{{beginList}}" wx:for-item="item" wx:key="id">
                            <view bindtap="beginChatSend" data-title="{{item.tips}}" class="begin-item">
                                <text>{{item.tips}}</text>
                                <view class="open-icon">
                                    <text class="arrow">‚Üí</text>
                                </view>
                            </view>
                        </view>
                    </view>
                </view>
                
                <!-- ÂØπËØùÂÜÖÂÆπ -->
                <view wx:else class="chatcontent">
                    <block wx:for="{{chatList}}" wx:for-item="item" wx:key="id">
                        <view class="chat-item">
                            <view class="item-time" wx:if="{{item.time}}">{{item.time}}</view>
                            
                            <!-- AIÂõûÂ§ç -->
                            <view wx:if="{{item.role == 'assistant'}}" class="message-container ai-message">
                                <view class="item-left">
                                    <view class="item-img">
                                        <image src="{{mediaUrls.icowwn}}" mode="aspectFit" class="item-photo ai-avatar"/>
                                    </view>
                                    <view class="item-content ai-content" bindtap="playTextToSpeech" data-content="{{item.content}}">
                                        <wemark md="{{item.content}}" highlight type="wemark"></wemark>
                                        <view class="copy-button" data-content="{{item.content}}"
                                              bindtap="copyChatContent">
                                            <image src="{{mediaUrls.copy}}" mode="aspectFit"/>
                                        </view>
                                        <!-- ËØ≠Èü≥Êí≠ÊîæÊèêÁ§∫ -->
                                        <view class="tts-hint">
                                            <van-icon name="volume-o" size="12" color="#FF9800"/>
                                            <text>ÁÇπÂáªÊí≠ÊîæËØ≠Èü≥</text>
                                        </view>
                                    </view>
                                </view>
                            </view>
                            
                            <!-- Áî®Êà∑Ê∂àÊÅØ -->
                            <view wx:if="{{item.role == 'user'}}" class="message-container user-message">
                                <view class="item-right">
                                    <view class="item-content user-content">{{item.content}}</view>
                                    <view class="item-img">
                                        <image src="{{mediaUrls.default}}" mode="aspectFill" class="item-photo user-avatar"/>
                                    </view>
                                </view>
                            </view>
                        </view>
                    </block>
                    
                    <!-- AIÊ≠£Âú®ÂõûÂ§ç -->
                    <view wx:if="{{answer_loading}}" class="message-container ai-message">
                        <view class="item-left">
                            <view class="item-img">
                                <image src="{{mediaUrls.icowwn}}" mode="aspectFit" class="item-photo ai-avatar"/>
                            </view>
                            <view class="item-content ai-content" wx:if="{{answerDesc}}" bindtap="playTextToSpeech" data-content="{{answerDesc}}">
                                <view class="typing-indicator" wx:if="{{!answerDesc}}">
                                    <view class="typing-dot"></view>
                                    <view class="typing-dot"></view>
                                    <view class="typing-dot"></view>
                                </view>
                                <wemark md="{{answerDesc}}" highlight type="wemark"></wemark>
                                <view class="copy-button" wx:if="{{answerDesc}}" data-content="{{answerDesc}}" bindtap="copyChatContent">
                                    <image src="{{mediaUrls.copy}}" mode="aspectFit"/>
                                </view>
                                <!-- ËØ≠Èü≥Êí≠ÊîæÊèêÁ§∫ -->
                                <view class="tts-hint" wx:if="{{answerDesc}}">
                                    <van-icon name="volume-o" size="12" color="#FF9800"/>
                                    <text>ÁÇπÂáªÊí≠ÊîæËØ≠Èü≥</text>
                                </view>
                            </view>
                        </view>
                    </view>
                </view>
            </view>
            
            <!-- Â∫ïÈÉ®ÁïôÁôΩÔºåÁ°Æ‰øùÂÜÖÂÆπ‰∏çË¢´ËæìÂÖ•Ê°ÜÈÅÆÊå° -->
            <view class="bottom-space"></view>
        </scroll-view>
    </view>
    
    <!-- ËæìÂÖ•Âå∫Âüü -->
    <view class="title-view" style="height: {{inputAreaHeight}}px;" catchtap="onClickInside">
        <!-- ËæìÂÖ•ÊñπÂºèÂàáÊç¢ -->
        <view class="input-mode-switch">
            <view class="mode-button {{inputMode === 'voice' ? 'active' : ''}}" bindtap="switchToVoice">
                <van-icon name="volume-o" size="18" color="{{inputMode === 'voice' ? '#ffffff' : '#FF9800'}}"/>
                <text>ËØ≠Èü≥</text>
            </view>
            <view class="mode-button {{inputMode === 'text' ? 'active' : ''}}" bindtap="switchToText">
                <van-icon name="edit" size="18" color="{{inputMode === 'text' ? '#ffffff' : '#FF9800'}}"/>
                <text>ÊñáÂ≠ó</text>
            </view>
        </view>
        
        <!-- ËØ≠Èü≥ËæìÂÖ•Âå∫Âüü -->
        <view wx:if="{{inputMode === 'voice' && isInputExpanded}}" class="voice-input-area">
            <view class="voice-container">
                <view class="voice-button {{isRecording ? 'recording' : ''}} {{isVoiceButtonPressed ? 'pressed' : ''}}" 
                      bindtouchstart="startVoiceRecording" 
                      bindtouchend="stopVoiceRecording"
                      bindtouchcancel="cancelVoiceRecording">
                    <van-icon name="{{isRecording ? 'pause' : 'volume-o'}}" size="32" color="#ffffff"/>
                </view>
                <view class="voice-status">
                    <text wx:if="{{!isRecording && !voiceText}}">Êåâ‰ΩèËØ¥ËØùÔºåÊùæÂºÄÂÅúÊ≠¢</text>
                    <text wx:if="{{isRecording}}">Ê≠£Âú®ÂΩïÈü≥‰∏≠...</text>
                    <text wx:if="{{!isRecording && voiceText}}">ËØ≠Èü≥ËØÜÂà´ÂÆåÊàê</text>
                </view>
            </view>
            
            <!-- ËØÜÂà´ÂêéÁöÑÊñáÂ≠óÊòæÁ§∫ÂíåÁºñËæë -->
            <view wx:if="{{voiceText}}" class="voice-text-edit">
                <textarea model:value="{{voiceText}}" 
                      class="voice-textarea"
                      placeholder="ÊÇ®ÂèØ‰ª•Âú®Ê≠§‰øÆÊîπËØÜÂà´ÁöÑÊñáÂ≠ó..."
                      auto-height="{{true}}"
                      maxlength="500"
                      bindinput="onVoiceTextChange"
                />
                <view class="voice-actions">
                    <view class="action-button secondary" bindtap="clearVoiceText">ÈáçÂΩï</view>
                    <view class="action-button primary" bindtap="sendVoiceText">ÂèëÈÄÅ</view>
                </view>
            </view>
        </view>
        
        <!-- ÊñáÂ≠óËæìÂÖ•Âå∫Âüü -->
        <view wx:if="{{inputMode === 'text' && isInputExpanded}}" class="input-container">
            <textarea model:value="{{title}}" 
                  class="input-textarea"
                  show-confirm-bar="{{false}}"
                  confirm-type="send" 
                  placeholder="ËØ∑ËæìÂÖ•ÊÇ®ÊÉ≥ÈóÆÁöÑÈóÆÈ¢ò..." 
                  bindconfirm="sendChat"
                  bindinput="adjustTextareaHeight"
                  auto-height="{{true}}"
                  maxlength="500"
                  cursor-spacing="30"
                  style="height: {{textareaHeight}}px; max-height: 90px; overflow-y: auto;"
                  scroll-y="{{true}}"
            />
            <text bindtap="sendChat" class="send-button">{{'ÂèëÈÄÅ'}}</text>
        </view>
    </view>
</view>
    <!-- Êñ∞Â¢ûËÅäÂ§©ÊåâÈíÆ -->
    <view bindtap="openAddChat" class="add-chat-btn" style="bottom: {{inputAreaHeight + 90}}px;">
        <text>+</text>
    </view>


    <!-- ‰æßËæπÊ†è -->
<view class="page">
    <view class="page-top {{open ? 'page-top-show' : ''}}">
        <view class="pageTitle">
            ÂØπËØùÂéÜÂè≤
        </view>
        <view class="page-scroll">
            <view class="empty-history">
                <view class="empty-text">ÊöÇÊó†ÂéÜÂè≤ÂØπËØù</view>
            </view>
            <view bindtap="creatChat" class="new-chat-btn">
                <view class="plus-icon">+</view>
                <text>Êñ∞ÂØπËØù</text>
            </view>
        </view>
        <view style="width: 100%;">
            <view bindtap="creatChat" class="creat-chat-btn">{{'Êñ∞Âª∫ÂØπËØù'}}</view>
        </view>
        <view class="close-icon" bindtap="cancelChat">
            <image src="{{app.getMediaUrl('left.png')}}" mode="aspectFit"></image>
        </view>
    </view>
</view>
