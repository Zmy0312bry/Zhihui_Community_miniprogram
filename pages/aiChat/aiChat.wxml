<view doc navBg="bg-gradient-green" title="{{typePage}}" ui="text-white">
    <!-- 点击外部区域的遮罩层 -->
    <view wx:if="{{isInputExpanded}}" class="input-mask" bindtap="onClickOutside"></view>
    
    <!--内容区域-->
    <view class="bottom-height content-view">
        <scroll-view
            class="scroll-text"
            type="list"
            scroll-y
            enable-passive
            scroll-top="{{scrollTop}}"
            upper-threshold="50"
            enhanced="true"
            bounces="true"
            show-scrollbar="false"
        >
            <view>
                <!-- 欢迎页面 -->
                <view wx:if="{{chatList.length<=0}}" class="begin">
                    <view class="welcome-header">
                        <image src="{{mediaUrls.icowwn}}" class="welcome-avatar" mode="aspectFit"/>
                    </view>
                    <view class="begin-title">{{beginTitle}}</view>
                    <view class="begin-tips">{{beginTips}}</view>
                    <view class="suggestion-list">
                        <view wx:for="{{beginList}}" wx:for-item="item" wx:key="id">
                            <view bindtap="beginChatSend" data-title="{{item.tips}}" class="begin-item">
                                <text>{{item.tips}}</text>
                                <view class="open-icon">
                                    <text class="arrow">→</text>
                                </view>
                            </view>
                        </view>
                    </view>
                </view>
                
                <!-- 对话内容 -->
                <view wx:else class="chatcontent">
                    <block wx:for="{{chatList}}" wx:for-item="item" wx:key="id">
                        <view class="chat-item">
                            <view class="item-time" wx:if="{{item.time}}">{{item.time}}</view>
                            
                            <!-- AI回复 -->
                            <view wx:if="{{item.role == 'assistant'}}" class="message-container ai-message">
                                <view class="item-left">
                                    <view class="item-img">
                                        <image src="{{mediaUrls.icowwn}}" mode="aspectFit" class="item-photo ai-avatar"/>
                                    </view>
                                    <view class="item-content ai-content">
                                        <wemark md="{{item.content}}" highlight type="wemark"></wemark>
                                        <view class="copy-button" data-content="{{item.content}}"
                                              bindtap="copyChatContent">
                                            <image src="{{mediaUrls.copy}}" mode="aspectFit"/>
                                        </view>
                                    </view>
                                </view>
                            </view>
                            
                            <!-- 用户消息 -->
                            <view wx:if="{{item.role == 'user'}}" class="message-container user-message">
                                <view class="item-right">
                                    <view class="item-content user-content">{{item.content}}</view>
                                    <view class="item-img">
                                        <image src="{{mediaUrls.default}}" mode="aspectFill" class="item-photo user-avatar"/>
                                    </view>
                                </view>
                            </view>
                        </view>
                    </block>
                    
                    <!-- AI正在回复 -->
                    <view wx:if="{{answer_loading}}" class="message-container ai-message">
                        <view class="item-left">
                            <view class="item-img">
                                <image src="{{mediaUrls.icowwn}}" mode="aspectFit" class="item-photo ai-avatar"/>
                            </view>
                            <view class="item-content ai-content">
                                <view class="typing-indicator" wx:if="{{!answerDesc}}">
                                    <view class="typing-dot"></view>
                                    <view class="typing-dot"></view>
                                    <view class="typing-dot"></view>
                                </view>
                                <wemark md="{{answerDesc}}" highlight type="wemark"></wemark>
                                <view class="copy-button" wx:if="{{answerDesc}}" data-content="{{answerDesc}}" bindtap="copyChatContent">
                                    <image src="{{mediaUrls.copy}}" mode="aspectFit"/>
                                </view>
                            </view>
                        </view>
                    </view>
                </view>
            </view>
            
            <!-- 底部留白，确保内容不被输入框遮挡 -->
            <view class="bottom-space"></view>
        </scroll-view>
    </view>
    
    <!-- 输入区域 -->
    <view class="title-view" style="height: {{inputAreaHeight}}px;" catchtap="onClickInside">
        <!-- 输入方式切换 -->
        <view class="input-mode-switch">
            <view class="mode-button {{inputMode === 'voice' ? 'active' : ''}}" bindtap="switchToVoice">
                <van-icon name="volume-o" size="18" color="{{inputMode === 'voice' ? '#ffffff' : '#4CAF50'}}"/>
                <text>语音</text>
            </view>
            <view class="mode-button {{inputMode === 'text' ? 'active' : ''}}" bindtap="switchToText">
                <van-icon name="edit" size="18" color="{{inputMode === 'text' ? '#ffffff' : '#4CAF50'}}"/>
                <text>文字</text>
            </view>
        </view>
        
        <!-- 语音输入区域 -->
        <view wx:if="{{inputMode === 'voice' && isInputExpanded}}" class="voice-input-area">
            <view class="voice-container">
                <view class="voice-button {{isRecording ? 'recording' : ''}}" bindtap="toggleRecording">
                    <van-icon name="{{isRecording ? 'pause' : 'volume-o'}}" size="32" color="#ffffff"/>
                </view>
                <view class="voice-status">
                    <text wx:if="{{!isRecording && !voiceText}}">点击开始语音输入</text>
                    <text wx:if="{{isRecording}}">正在录音中...</text>
                    <text wx:if="{{!isRecording && voiceText}}">语音识别完成</text>
                </view>
            </view>
            
            <!-- 识别后的文字显示和编辑 -->
            <view wx:if="{{voiceText}}" class="voice-text-edit">
                <textarea model:value="{{voiceText}}" 
                      class="voice-textarea"
                      placeholder="您可以在此修改识别的文字..."
                      auto-height="{{true}}"
                      maxlength="500"
                      bindinput="onVoiceTextChange"
                />
                <view class="voice-actions">
                    <view class="action-button secondary" bindtap="clearVoiceText">重录</view>
                    <view class="action-button primary" bindtap="sendVoiceText">发送</view>
                </view>
            </view>
        </view>
        
        <!-- 文字输入区域 -->
        <view wx:if="{{inputMode === 'text' && isInputExpanded}}" class="input-container">
            <textarea model:value="{{title}}" 
                  class="input-textarea"
                  show-confirm-bar="{{false}}"
                  confirm-type="send" 
                  placeholder="请输入您想问的问题..." 
                  bindconfirm="sendChat"
                  bindinput="adjustTextareaHeight"
                  auto-height="{{true}}"
                  maxlength="500"
                  cursor-spacing="30"
                  style="height: {{textareaHeight}}px; max-height: 90px; overflow-y: auto;"
                  scroll-y="{{true}}"
            />
            <text bindtap="sendChat" class="send-button">{{'发送'}}</text>
        </view>
    </view>
</view>
    <!-- 新增聊天按钮 -->
    <view bindtap="openAddChat" class="add-chat-btn" style="bottom: {{inputAreaHeight + 90}}px;">
        <text>+</text>
    </view>


    <!-- 侧边栏 -->
<view class="page">
    <view class="page-top {{open ? 'page-top-show' : ''}}">
        <view class="pageTitle">
            对话历史
        </view>
        <view class="page-scroll">
            <view wx:if="{{dialogue_list.length === 0}}" class="empty-history">
                <view class="empty-text">暂无历史对话</view>
                <view bindtap="creatChat" class="new-chat-btn">开始新对话</view>
            </view>
            <view class="nav-list" wx:for="{{dialogue_list}}" wx:key="dialogueId">
                <view class="nav-item-item">
                    <view class="nav-item-con" bindtap="open_chat" data-title="{{item.firstContent}}"
                          data-id="{{item.dialogueId}}">
                        <view class="nav-item-title">{{item.firstContent}}</view>
                        <view class="nav-item-time">{{item.createTime}}</view>
                    </view>
                    <view class="nav-item-del">
                        <text data-id="{{item.dialogueId}}" bindtap="del_chat">×</text>
                    </view>
                </view>
            </view>
            <view bindtap="creatChat" class="new-chat-btn">
                <view class="plus-icon">+</view>
                <text>新对话</text>
            </view>
        </view>
        <view style="width: 100%;">
            <view bindtap="creatChat" class="creat-chat-btn">{{'新建对话'}}</view>
            <!--    <view bindtap="cancelChat" class="cancel-chat-btn">{{'关闭弹窗'}}</view>-->
        </view>
        <view class="close-icon" bindtap="cancelChat">
            <image src="{{app.getMediaUrl('left.png')}}" mode="aspectFit"></image>
        </view>
    </view>
</view>
