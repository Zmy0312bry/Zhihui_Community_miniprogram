<view doc navBg="bg-gradient-green" title="{{typePage}}" ui="text-white">
    <!-- 点击外部区域的遮罩层 -->
    <view wx:if="{{isInputExpanded}}" class="input-mask" bindtap="onClickOutside"></view>

    <!-- 自定义加载动画 -->
    <view wx:if="{{ttsLoading}}" class="tts-loading-overlay">
        <view class="tts-loading-container">
            <view class="tts-loading-spinner">
                <view class="tts-loading-dot" wx:for="{{[1,2,3]}}" wx:key="*this"></view>
            </view>
            <view class="tts-loading-text">{{ttsLoadingText}}</view>
            <view class="tts-loading-progress">
                <view class="tts-progress-bar" style="width: {{ttsProgress}}%"></view>
            </view>
        </view>
    </view>

    <!--内容区域-->
    <view class="bottom-height content-view">
        <!-- 水印背景层 -->
        <view class="watermark-layer"></view>
        
        <scroll-view
            class="scroll-text"
            type="list"
            scroll-y
            enable-passive
            scroll-top="{{scrollTop}}"
            upper-threshold="50"
            enhanced="true"
            bounces="true"
            show-scrollbar="false"
        >
            <view>
                <!-- 欢迎页面 -->
                <view wx:if="{{chatList.length<=0}}" class="begin">
                    <view class="welcome-header">
                        <image src="{{mediaUrls.icowwn}}" class="welcome-avatar" mode="aspectFit"/>
                    </view>
                    <view class="begin-title">{{beginTitle}}</view>
                    <view class="begin-tips">{{beginTips}}</view>
                    <view class="tts-feature-hint">
                        <van-icon name="volume-o" size="16" color="#FF9800"/>
                        <text>💡 点击AI回复内容即可播放语音</text>
                    </view>
                    <view class="suggestion-list">
                        <view wx:for="{{beginList}}" wx:for-item="item" wx:key="id">
                            <view bindtap="beginChatSend" data-title="{{item.tips}}" class="begin-item">
                                <text>{{item.tips}}</text>
                                <view class="open-icon">
                                    <text class="arrow">→</text>
                                </view>
                            </view>
                        </view>
                    </view>
                    <view class="ai-disclaimer">
                        <text>本服务基于AI技术生成内容，结果仅供参考。请勿将其作为医疗、法律或其他专业建议。对于重要决定，建议咨询专业人士。</text>
                    </view>
                </view>
                
                <!-- 对话内容 -->
                <view wx:else class="chatcontent">
                    <block wx:for="{{chatList}}" wx:for-item="item" wx:key="id">
                        <view class="chat-item">
                            <view class="item-time" wx:if="{{item.time}}">{{item.time}}</view>
                            
                            <!-- AI回复 -->
                            <view wx:if="{{item.role == 'assistant'}}" class="message-container ai-message">
                                <view class="item-left">
                                    <view class="item-img">
                                        <image src="{{mediaUrls.icowwn}}" mode="aspectFit" class="item-photo ai-avatar"/>
                                    </view>
                                    <view>
                                        <view class="item-content ai-content" bindtap="playTextToSpeech" data-content="{{item.content}}" data-index="{{index}}">
                                            <wemark md="{{item.content}}" highlight type="wemark"></wemark>
                                            <view class="copy-button" data-content="{{item.content}}"
                                                  bindtap="copyChatContent">
                                                <image src="{{mediaUrls.copy}}" mode="aspectFit"/>
                                            </view>
                                            <!-- 语音播放提示 -->
                                            <view class="tts-hint {{item.ttsHintClass}}" bindtap="playTextToSpeech" data-content="{{item.content}}" data-index="{{index}}">
                                                <van-icon name="{{item.ttsIconName}}" size="14"/>
                                                <text>{{item.ttsHintText}}</text>
                                            </view>
                                        </view>
                                        <!-- AI内容提示 -->
                                        <view class="ai-content-hint">此内容为AI技术生成，仅供参考</view>
                                    </view>
                                </view>
                            </view>
                            
                            <!-- 用户消息 -->
                            <view wx:if="{{item.role == 'user'}}" class="message-container user-message">
                                <view class="item-right">
                                    <view class="item-content user-content">{{item.content}}</view>
                                    <view class="item-img">
                                        <image src="{{mediaUrls.default}}" mode="aspectFill" class="item-photo user-avatar"/>
                                    </view>
                                </view>
                            </view>
                        </view>
                    </block>
                    
                    <!-- AI正在回复 -->
                    <view wx:if="{{answer_loading}}" class="message-container ai-message">
                        <view class="item-left">
                            <view class="item-img">
                                <image src="{{mediaUrls.icowwn}}" mode="aspectFit" class="item-photo ai-avatar"/>
                            </view>
                            <view>
                                <view class="item-content ai-content" wx:if="{{answerDesc}}" bindtap="playTextToSpeech" data-content="{{answerDesc}}">
                                    <view class="typing-indicator" wx:if="{{!answerDesc}}">
                                        <view class="typing-dot"></view>
                                        <view class="typing-dot"></view>
                                        <view class="typing-dot"></view>
                                    </view>
                                    <wemark md="{{answerDesc}}" highlight type="wemark"></wemark>
                                    <view class="copy-button" wx:if="{{answerDesc}}" data-content="{{answerDesc}}" bindtap="copyChatContent">
                                        <image src="{{mediaUrls.copy}}" mode="aspectFit"/>
                                    </view>
                                    <!-- 语音播放提示 -->
                                    <view class="tts-hint" wx:if="{{answerDesc}}" bindtap="playTextToSpeech" data-content="{{answerDesc}}">
                                        <van-icon name="volume-o" size="14"/>
                                        <text>点击播放语音</text>
                                    </view>
                                </view>
                                <!-- AI内容提示 -->
                                <view class="ai-content-hint" wx:if="{{answerDesc}}">此内容为AI技术生成，仅供参考</view>
                            </view>
                        </view>
                    </view>
                </view>
            </view>
            
            <!-- 底部留白，确保内容不被输入框遮挡 -->
            <view class="bottom-space"></view>
        </scroll-view>
    </view>
    
    <!-- 输入区域 -->
    <view class="title-view" style="height: {{inputAreaHeight}}px;" catchtap="onClickInside">
        <!-- 输入方式切换 -->
        <view class="input-mode-switch">
            <view class="mode-button {{inputMode === 'voice' ? 'active' : ''}}" bindtap="switchToVoice">
                <van-icon name="volume-o" size="18" color="{{inputMode === 'voice' ? '#ffffff' : '#FF9800'}}"/>
                <text>语音</text>
            </view>
            <view class="mode-button {{inputMode === 'text' ? 'active' : ''}}" bindtap="switchToText">
                <van-icon name="edit" size="18" color="{{inputMode === 'text' ? '#ffffff' : '#FF9800'}}"/>
                <text>文字</text>
            </view>
        </view>
        
        <!-- 语音输入区域 -->
        <view wx:if="{{inputMode === 'voice' && isInputExpanded}}" class="voice-input-area">
            <view class="voice-container">
                <view class="voice-button {{isRecording ? 'recording' : ''}} {{isVoiceButtonPressed ? 'pressed' : ''}}" 
                      bindtouchstart="startVoiceRecording" 
                      bindtouchend="stopVoiceRecording"
                      bindtouchcancel="cancelVoiceRecording">
                    <van-icon name="{{isRecording ? 'pause' : 'volume-o'}}" size="32" color="#ffffff"/>
                </view>
                <view class="voice-status">
                    <text wx:if="{{!isRecording && !voiceText}}">按住说话，松开停止</text>
                    <text wx:if="{{isRecording}}">正在录音中...</text>
                    <text wx:if="{{!isRecording && voiceText}}">语音识别完成</text>
                </view>
            </view>
            
            <!-- 识别后的文字显示和编辑 -->
            <view wx:if="{{voiceText}}" class="voice-text-edit">
                <textarea model:value="{{voiceText}}" 
                      class="voice-textarea"
                      placeholder="您可以在此修改识别的文字..."
                      auto-height="{{true}}"
                      maxlength="500"
                      bindinput="onVoiceTextChange"
                />
                <view class="voice-actions">
                    <view class="action-button secondary" bindtap="clearVoiceText">重录</view>
                    <view class="action-button primary" bindtap="sendVoiceText">发送</view>
                </view>
            </view>
        </view>
        
        <!-- 文字输入区域 -->
        <view wx:if="{{inputMode === 'text' && isInputExpanded}}" class="input-container">
            <textarea model:value="{{title}}" 
                  class="input-textarea"
                  show-confirm-bar="{{false}}"
                  confirm-type="send" 
                  placeholder="请输入您想问的问题..." 
                  bindconfirm="sendChat"
                  bindinput="adjustTextareaHeight"
                  auto-height="{{true}}"
                  maxlength="500"
                  cursor-spacing="30"
                  style="height: {{textareaHeight}}px; max-height: 90px; overflow-y: auto;"
                  scroll-y="{{true}}"
            />
            <text bindtap="sendChat" class="send-button">{{'发送'}}</text>
        </view>
    </view>
</view>
    <!-- 新增聊天按钮 -->
    <view bindtap="openAddChat" class="add-chat-btn" style="bottom: {{inputAreaHeight + 90}}px;">
        <text>+</text>
    </view>
